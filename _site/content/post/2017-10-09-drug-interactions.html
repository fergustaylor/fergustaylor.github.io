---
title: Drug Interactions
author: ~
date: '2017-10-09'
slug: drug-interactions
categories:
  - BNF
tags: []
header_image: "/blogimages/sankeyexample.png"
output:
  blogdown::html_page
---



<p>I was thinking about drug interactions the other day; as I listened to a conversation between 2 doctors on the relevant, and/or dangerous interactions that could have occured in a patient with multiple comorbidities. And I realised then, how few of these interactions I’d learnt by-heart yet then. Rather, if I’d wanted to check, I would have looked the patient’s drugs up in the BNF individually. I thought then that I should try to plot them, in the spirit of trying to understand them all, (which I’ll likely never do as new, obscure drugs come out, or as drug interactions are discovered over time).</p>
<p>As such - I’ve been trying to learn 2 new skills - webscraping to collect the data (in this first post), and the use of <a href="https://d3js.org">D3</a> to present it. Which is one of the larger current standards for web graphics, including many notable newspapers.</p>
<p>Luckily all the drug interactions are listed <a href="https://bnf.nice.org.uk/interaction/">online</a> through the BNF, so I can import and update all this information easily. There are much better ways to do this, however as a novice I noticed that each drug interaction page follows the same format wherein the phrase “View all interactions for [drug]” appears underneath each interactant. As such, I can search for each instance of the phrase, and take the drug names from each example.</p>
<p>For example - Abacavir {{&lt; img src=“blogimages/abacavir.png” &gt;}}</p>
<pre class="r"><code>library(rvest)
library(magrittr)
library(stringr)
library(tidyverse)

examplehtml &lt;- &quot;https://bnf.nice.org.uk/interaction/abacavir-2.html&quot;

example_string &lt;- str_c(&quot;#&quot;, examplehtml) %&gt;%
  str_replace(&quot;https://bnf.nice.org.uk/interaction/&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;.html&quot;, replacement= &quot;&quot;)

example_string2 &lt;- examplehtml %&gt;%
  str_replace(&quot;https://bnf.nice.org.uk/interaction/&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;.html&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;-2&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace_all(&quot;-&quot;, replacement= &quot; &quot;) %&gt;%
  str_to_title()

list_example &lt;- read_html(examplehtml) %&gt;%
  html_nodes(example_string) %&gt;%
  html_text() %&gt;%
  strsplit(split = &quot;\n&quot;) %&gt;%
  unlist() %&gt;%
  str_trim(side = &quot;both&quot;) %&gt;%
  str_subset(&quot;View all interactions&quot;) %&gt;%
  str_replace_all(pattern = &quot;View all interactions for &quot;, replacement = &quot;&quot;)

dataframe_example &lt;- data.frame(drug=example_string2, interacts_with=list_example, row.names=NULL)</code></pre>
<p>This gives me a table of the example abacavir, an antiviral.</p>
<pre><code>##       drug interacts_with
## 1 Abacavir   Fosphenytoin
## 2 Abacavir      Methadone
## 3 Abacavir       Orlistat
## 4 Abacavir  Phenobarbital
## 5 Abacavir      Phenytoin
## 6 Abacavir      Primidone
## 7 Abacavir      Ribavirin
## 8 Abacavir     Rifampicin
## 9 Abacavir     Tipranavir</code></pre>
<p>So if I make it into a function.</p>
<pre class="r"><code>interactionstable &lt;- function(url){

example_string &lt;- str_c(&quot;#&quot;, url) %&gt;%
  str_replace(&quot;https://bnf.nice.org.uk/interaction/&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;.html&quot;, replacement= &quot;&quot;)

example_string2 &lt;- url %&gt;%
  str_replace(&quot;https://bnf.nice.org.uk/interaction/&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;.html&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;-2&quot;, replacement= &quot;&quot;) %&gt;%
  str_replace(&quot;-&quot;, replacement= &quot; &quot;) %&gt;%
  str_to_title()

list_example &lt;- read_html(url) %&gt;%
  html_nodes(example_string) %&gt;%
  html_text() %&gt;%
  strsplit(split = &quot;\n&quot;) %&gt;%
  unlist() %&gt;%
  str_trim(side = &quot;both&quot;) %&gt;%
  str_subset(&quot;View all interactions&quot;) %&gt;%
  str_replace_all(pattern = &quot;View all interactions for &quot;, replacement = &quot;&quot;)

class_example &lt;- read_html(url) %&gt;%
  html_nodes(&quot;h3&quot;) %&gt;%
  html_text() %&gt;%
  strsplit(split = &quot;\n&quot;) %&gt;%
  unlist() %&gt;%
  str_trim(side = &quot;both&quot;) %&gt;%
  str_subset(&quot;belongs to&quot;) %&gt;%
  str_replace_all(pattern = &quot; and has the following interaction information&quot;, replacement = &quot;&quot;) %&gt;%
  strsplit(&quot;.* belongs to &quot;) %&gt;%
  unlist()

if (identical(list_example, character(0))==FALSE){
  dataframe_example &lt;- data.frame(drug=example_string2, interacts_with=list_example, class=class_example[2], row.names=NULL)
}
else {dataframe_example &lt;- data.frame(drug=example_string2, interacts_with=NA, class=class_example[2], row.names=NULL)
}

as.character(dataframe_example$drug)
as.character(dataframe_example$interacts_with)

return(dataframe_example)
}</code></pre>
<p>Then I create a list of each URL, (i.e each drug/general class listed in the index).</p>
<pre class="r"><code>drugs_list &lt;- paste(readLines(&quot;https://bnf.nice.org.uk/interaction/&quot;), collapse=&quot;\n&quot;) %&gt;%
  str_match_all(&quot;&lt;a href=\&quot;(.*?)\&quot;&quot;) %&gt;%
  unlist() %&gt;%
  str_replace_all(pattern = &quot;&lt;a href=\&quot;&quot;, replacement=&quot;&quot;) %&gt;%
  str_replace_all(pattern = &quot;\&quot;&quot;, replacement=&quot;&quot;) %&gt;%
  unique()
drugs_list &lt;- drugs_list[34:1206]
drugs_list &lt;- str_c(&quot;https://bnf.nice.org.uk/interaction/&quot;, drugs_list)</code></pre>
<p>I can apply my function to everything, and create a dataset. I’ve done this in thirds due to the size of data involved; any larger any it timed-out partway through.</p>
<pre class="r"><code>first &lt;- bind_rows(lapply(drugs_list[1:300], interactionstable))
second &lt;- bind_rows(lapply(drugs_list[301:600], interactionstable))
third &lt;- bind_rows(lapply(drugs_list[601:1173], interactionstable))

dataset &lt;- bind_rows(first, second, third)</code></pre>
<p>I’ll add classes next and try to apply this data to a D3 model, such as a Sankey diagram.</p>
